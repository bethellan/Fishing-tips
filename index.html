<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NZ Beach Fishing Planner — PWA (DEBUG v12)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2e7d32">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root { --fg:#111; --muted:#666; --ok:#d17f00; --good:#2e7d32; --bad:#b00020; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:var(--fg); }
  header { padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; gap:10px; align-items:center; }
  h1 { margin: 0; font-size: 18px; }
  #app { display:grid; grid-template-columns: 370px 1fr; gap:12px; height: calc(100vh - 56px); }
  #sidebar { padding: 12px 16px; overflow:auto; border-right: 1px solid #eee;}
  #map { width: 100%; height: 100%; }
  .group { margin-bottom: 12px; }
  label { display:block; font-size: 12px; color: var(--muted); margin: 6px 0 4px; }
  select, input[type="text"], input[type="number"] { width: 100%; padding: 8px; border:1px solid #ddd; border-radius:8px; }
  button { padding: 8px 10px; border: 1px solid #ddd; background: #fafafa; border-radius: 8px; cursor:pointer; }
  button.primary { background: #2e7d32; color: white; border-color: #2e7d32; }
  .row { display:flex; gap:8px; }
  .row > * { flex:1; }
  .card { border:1px solid #eee; border-radius: 10px; padding: 10px; margin: 8px 0; }
  .score { font-weight: 700; font-size: 18px; }
  .score-label { font-size:12px; color:var(--muted); margin-top:2px; }
  .good { color: var(--good); } .ok { color: var(--ok); } .bad { color: var(--bad); }
  small { color:var(--muted); }
  .hint { font-size:12px; color: var(--muted); }
  details { margin-top:6px; }
  .chips { display:flex; flex-wrap: wrap; gap:6px; margin-top:4px; }
  .chip { padding:3px 6px; border-radius:999px; background:#f0f0f0; font-size:12px;}
  .section { margin-top:8px; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .grid3 { display:grid; grid-template-columns: repeat(3,1fr); gap:6px; }
  .fish { border:1px solid #eee; border-radius:8px; padding:6px; font-size:13px; }
  #dbg { position: fixed; right: 8px; bottom: 8px; background: #fff8c5; border: 1px solid #e5c200; padding: 8px 10px; border-radius: 8px; font-size: 12px; max-width: 46vw; max-height: 40vh; overflow:auto; box-shadow: 0 2px 10px rgba(0,0,0,.1); white-space: pre-line; }
</style>
</head>
<body>
<header>
  <h1>NZ Beach Fishing Planner — PWA</h1>
  <div class="legend">Install via browser menu → Add to Home Screen. App shell works offline; data needs reception. (Build: DEBUG v12)</div>
</header>

<div id="app">
  <div id="sidebar">
    <!-- Region / species selectors -->
    <div class="group row">
      <div>
        <label>Region</label>
        <select id="region">
          <option value="wellington">Wellington City & South Coast</option>
          <option value="kapiti">Kāpiti & Horowhenua</option>
          <option value="wairarapa">Wairarapa / Palliser</option>
          <option value="westcoast_north">West Coast (NI)</option>
          <option value="bayofplenty">Bay of Plenty</option>
          <option value="westcoast_south">West Coast (SI)</option>
          <option value="all">All loaded</option>
        </select>
      </div>
      <div>
        <label>Target species</label>
        <select id="species">
          <option value="mixed">Mixed surf</option>
          <option value="moki">Moki</option>
          <option value="kingfish">Kingfish</option>
          <option value="trevally">Trevally</option>
          <option value="snapper">Snapper</option>
          <option value="gurnard">Gurnard</option>
        </select>
      </div>
    </div>

    <div class="group">
      <label>Preloaded spots</label>
      <select id="spotList" multiple size="10"></select>
    </div>

    <div class="group">
      <label>NIWA Tides API key</label>
      <input id="niwaKey" type="text" placeholder="Paste key" />
    </div>

    <button id="score" class="primary">Score Spots</button>
    <div id="suggestions"></div>
  </div>
  <div id="map"></div>
</div>

<div id="dbg">Debug: loading…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function(){
  const dbg = document.getElementById('dbg');
  function log(m){console.log(m); dbg.textContent+="\\n"+m;}

  log("Creating map…");
  const map = L.map('map').setView([-41.3,174.8], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  log("Map created");

  // Preload some spots (shortened for clarity)
  const DB = [
    {id:'seatoun', name:'Seatoun Beach', lat:-41.325, lon:174.833, orientation:60, region:'wellington'},
    {id:'lyall', name:'Lyall Bay', lat:-41.329, lon:174.798, orientation:180, region:'wellington'},
    {id:'mt_maunganui', name:'Mount Maunganui Main Beach', lat:-37.634, lon:176.185, orientation:50, region:'bayofplenty'},
    {id:'ohope', name:'Ōhope Beach', lat:-37.967, lon:177.074, orientation:80, region:'bayofplenty'}
  ];
  log("DB loaded: "+DB.length+" spots");

  function populateList(){
    const region=document.getElementById('region').value;
    const list=document.getElementById('spotList');
    list.innerHTML='';
    DB.filter(s=>region==='all'||s.region===region).forEach(s=>{
      const o=document.createElement('option');
      o.value=s.id; o.textContent=s.name; list.appendChild(o);
    });
    log("Spot list populated for region "+region);
  }
  document.getElementById('region').onchange=populateList;
  populateList();

  document.getElementById('score').onclick=()=>{
    const ids=[...document.getElementById('spotList').selectedOptions].map(o=>o.value);
    if(!ids.length){alert("Select a spot"); return;}
    const out=document.getElementById('suggestions');
    out.innerHTML="";
    ids.forEach(id=>{
      const spot=DB.find(s=>s.id===id);
      out.innerHTML+=`<div class="card"><b>${spot.name}</b><br>
        <span class="chip">Wind ${ (10*3.6).toFixed(1)} km/h</span>
        <span class="chip">Example tide data here…</span>
      </div>`;
    });
  };
})();
</script>
</body>
</html>